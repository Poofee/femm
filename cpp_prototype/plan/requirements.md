# Elmer FEM C++移植项目需求文档

## 项目概述

本项目旨在将Elmer FEM（基于Fortran的有限元分析软件）的核心功能逐步移植到现代C++架构。Elmer FEM是一个开源的有限元分析软件，主要用于多物理场仿真，特别擅长低频电磁场分析。

## 核心需求

### 1. 技术目标
- **性能提升**: 利用现代C++特性优化计算性能
- **代码可维护性**: 改善代码结构，提高可读性和可维护性
- **现代工具链**: 支持现代开发工具和库（如Eigen、CMake）
- **并行计算**: 为多核和GPU计算提供更好的支持

### 2. 功能需求

#### 2.1 核心数值算法
- [x] 线性代数运算（矩阵、向量操作）
- [x] 迭代求解器（CG、BiCGStab、GMRES等）
- [ ] 直接求解器（LU分解、Cholesky等）
- [ ] 预处理技术（ILU、AMG等）

#### 2.2 有限元核心功能
- [ ] 网格数据结构和管理
- [ ] 单元类型支持（线性、二次、三次单元）
- [ ] 形函数和数值积分
- [ ] 刚度矩阵组装
- [ ] 边界条件处理

#### 2.3 物理场求解器
- [ ] 低频电磁场求解器
- [ ] 热传导求解器
- [ ] 结构力学求解器
- [ ] 流体力学求解器
- [ ] 多物理场耦合

#### 2.4 前后处理
- [ ] 网格文件I/O（Gmsh、Netgen格式）
- [ ] 结果文件输出（VTK、Paraview格式）
- [ ] 可视化接口

## 技术约束

### 3.1 兼容性要求
- **向后兼容**: 保持与现有Fortran代码的互操作性
- **平台支持**: Windows、Linux、macOS跨平台支持
- **编译器**: 支持MSVC、GCC、Clang等主流编译器

### 3.2 性能指标
- **内存效率**: 优化大型稀疏矩阵存储
- **计算速度**: 关键算法性能不低于Fortran版本
- **可扩展性**: 支持百万级自由度的计算

### 3.3 质量要求
- **代码质量**: 遵循现代C++最佳实践
- **测试覆盖**: 单元测试覆盖关键功能
- **文档完整**: API文档和用户指南

## 项目范围

### 4.1 包含的功能
- 核心有限元算法库
- 主要物理场求解器
- 基本的前后处理功能
- 性能优化和并行计算支持

### 4.2 排除的功能（第一阶段）
- 图形用户界面（GUI）
- 高级可视化功能
- 特定领域的专业模块
- 商业求解器接口

## 成功标准

### 5.1 技术成功标准
- [ ] 核心算法性能达到或超过Fortran版本
- [ ] 代码通过完整的测试套件
- [ ] 支持主要物理场求解器
- [ ] 具备良好的扩展性和维护性

### 5.2 项目成功标准
- [ ] 完成第一阶段移植（6个月）
- [ ] 建立稳定的开发流程
- [ ] 形成活跃的开发社区
- [ ] 获得用户认可和采用

## 风险评估

### 6.1 技术风险
- **性能风险**: C++实现可能不如优化的Fortran代码
- **兼容性风险**: Fortran-C++互操作可能存在问题
- **复杂性风险**: 有限元算法实现复杂度高

### 6.2 缓解措施
- 采用渐进式移植策略
- 建立性能基准测试
- 保持与现有代码的兼容性
- 采用模块化设计降低复杂度

## 依赖关系

### 7.1 外部依赖
- **Eigen库**: 线性代数运算
- **CMake**: 构建系统
- **VTK**: 可视化支持（可选）
- **MPI**: 并行计算支持（可选）

### 7.2 内部依赖
- 现有Elmer FEM Fortran代码库
- 测试用例和验证数据
- 文档和用户指南

## 验收标准

### 8.1 第一阶段验收（3个月）
- [x] 建立基本的C++项目结构
- [x] 实现核心线性代数功能
- [x] 验证基本求解器算法
- [ ] 建立性能测试框架

### 8.2 第二阶段验收（6个月）
- [ ] 完成核心有限元功能移植
- [ ] 实现主要物理场求解器
- [ ] 建立完整的测试套件
- [ ] 提供基础文档

## 迁移路线图（2026年1月更新）

### 当前实现状态评估（截至2026年1月）

#### 已完成的坚实基础 ✅
- **有限元形状函数系统**：1D、2D、3D单元支持
- **高斯积分系统**：各种单元类型和积分阶数
- **单元矩阵组装**：刚度矩阵、质量矩阵、传导矩阵等
- **线性代数核心**：CRS矩阵、迭代求解器（CG、Jacobi、Gauss-Seidel）
- **电磁材料属性**：支持非线性B-H曲线
- **多物理场求解器框架**：弱耦合、强耦合、迭代耦合
- **热传导求解器**：稳态/瞬态、传导/对流/辐射
- **结构力学求解器**：线性弹性、热膨胀、应力应变计算
- **统一材料类**：电磁、热、机械属性集成

#### 关键缺失组件（按优先级排序）

### 第一阶段：基础架构完善（立即开始）

**1. 边界条件处理系统** ⭐⭐⭐⭐⭐
- Dirichlet、Neumann、Robin边界条件
- 电磁场特定边界条件（磁对称、电绝缘等）
- 边界条件注册和管理机制

**2. 网格I/O和文件格式支持** ⭐⭐⭐⭐
- Elmer网格格式(.grd)读写
- Gmsh、VTK等常用格式支持
- 网格数据结构和分区支持

**3. 求解器接口和注册机制** ⭐⭐⭐⭐
- 统一求解器接口设计
- 求解器注册和发现机制
- 参数配置和运行时选择

### 第二阶段：核心电磁求解器移植（核心功能）

**4. MagnetoDynamics2D求解器** ⭐⭐⭐⭐⭐
- 二维磁动力学问题（笛卡尔和柱对称）
- 矢量势单分量简化
- 非线性材料支持
- 现代推荐使用的求解器

**5. WhitneyAVSolver三维求解器** ⭐⭐⭐⭐
- 三维磁动力学问题
- Whitney元素支持
- A-φ公式实现

**6. 电磁工具函数模块** ⭐⭐⭐
- 场计算和后处理工具
- 材料属性计算函数
- 边界条件处理工具

### 第三阶段：扩展功能（中优先级）

**7. 电路耦合功能** ⭐⭐⭐
- 电磁场与外部电路耦合
- 电流源和电压源支持
- 电路元件建模

**8. 多物理场耦合增强** ⭐⭐⭐
- 电磁-热耦合完善
- 电磁-结构耦合优化
- 耦合算法性能提升

### 第四阶段：高级功能（低优先级）

**9. 特殊电磁求解器** ⭐⭐
- 电磁波求解器（EMWaveSolver）
- 傅里叶损失计算（FourierLoss）
- 磁滞模型支持（ZirkaHysteresis）

### 实施策略和技术重点

**技术架构原则：**
- 保持与现有C++代码接口一致性
- 充分利用已实现的线性代数和有限元基础设施
- 采用现代C++设计模式（RAII、智能指针等）
- 确保内存安全和性能优化

**迁移策略：**
- 逐个模块移植，确保每个模块功能完整
- 建立测试用例验证移植正确性
- 保持与Fortran版本的接口兼容性，便于对比验证
- 渐进式开发，从基础架构到核心功能再到扩展功能

**性能目标：**
- 关键算法性能不低于Fortran版本
- 支持百万级自由度的计算规模
- 优化内存使用和计算效率

---

*文档版本: 1.1*  
*最后更新: 2026-01-09*  
*负责人: 项目架构师*